<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/theme-change@2.0.2/index.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- DataTables CSS (Tailwind-compatible style) -->
    <link
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
      rel="stylesheet"
    />

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <title>Price Checker - Product List</title>
    <style>
      .dataTables_filter input {
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        padding: 0.25rem 0.5rem;
        width: 16rem;
        font-size: 0.875rem;
      }

      .dataTables_length select {
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }

      .dataTables_paginate .paginate_button {
        margin-left: 0.25rem;
        margin-right: 0.25rem;
        padding: 0.25rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        color: #374151;
        cursor: pointer;
        background: transparent;
      }

      .dataTables_paginate .paginate_button.current {
        background-color: #3b82f6; /* daisyUI primary */
        color: white !important;
        border-color: #3b82f6;
      }

      .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .dataTables_info {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="drawer drawer-mobile">
      <!-- Checkbox toggles sidebar -->
      <input id="sidebar-toggle" type="checkbox" class="drawer-toggle" />

      <!-- Sidebar -->
      <div
        class="drawer-side min-h-[calc(100vh-4rem)] w-64 fixed top-16 left-0 z-40 bg-base-100 text-base-content"
      >
        <label for="sidebar-toggle" class="drawer-overlay"></label>

        <ul class="menu p-4 overflow-y-auto w-64">
          <li><a href="/index.html" class="font-semibold">Price Checker</a></li>
          <li>
            <details>
              <summary class="cursor-pointer font-semibold">Products</summary>
              <ul class="p-2">
                <li><a href="/productList.html">List</a></li>
              </ul>
            </details>
          </li>
        </ul>
      </div>

      <!-- Main content -->
      <div class="drawer-content flex flex-col min-h-screen">
        <!-- Navbar -->
        <div class="navbar bg-base-100 shadow-sm">
          <div class="navbar-start">
            <!-- Sidebar toggle button visible always -->
            <label
              for="sidebar-toggle"
              tabindex="0"
              class="btn btn-ghost lg:hidden"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h8m-8 6h16"
                />
              </svg>
            </label>
            <a class="btn btn-ghost text-xl normal-case">Maribeth Store</a>
          </div>

          <div class="navbar-end">
            <!-- Dark/Light mode toggle button on right side -->
            <button
              data-toggle-theme="dark,light"
              data-act-class="ACTIVECLASS"
              type="button"
              class="theme-toggle btn btn-ghost text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5"
              aria-label="Toggle Dark Mode"
            >
              <!-- Dark icon (moon) -->
              <svg
                class="theme-toggle-dark-icon w-5 h-5"
                fill="currentColor"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                ></path>
              </svg>
              <!-- Light icon (sun) -->
              <svg
                class="theme-toggle-light-icon w-5 h-5 hidden"
                fill="currentColor"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 
                  0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 
                  001.414-1.414l-.707-.707a1 1 0 
                  00-1.414 1.414zm2.12-10.607a1 1 0 010 
                  1.414l-.706.707a1 1 0 
                  11-1.414-1.414l.707-.707a1 1 0 
                  011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 
                  100 2h1zm-7 4a1 1 0 011 
                  1v1a1 1 0 11-2 0v-1a1 1 0 
                  011-1zM5.05 6.464A1 1 0 
                  106.465 5.05l-.708-.707a1 1 0 
                  00-1.414 1.414l.707.707zm1.414 
                  8.486l-.707.707a1 1 0 
                  01-1.414-1.414l.707-.707a1 1 0 
                  011.414 1.414zM4 11a1 1 0 
                  100-2H3a1 1 0 000 2h1z"
                ></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Main page content here -->
        <main class="p-6">
          <div
            class="card max-w-md mx-auto bg-base-300 dark:bg-base-300 shadow-lg rounded-lg p-6 space-y-4"
          >
            <div class="overflow-x-auto">
              <table id="product-table" class="table w-full">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Barcode</th>
                    <th>Price</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>
  </body>

  <dialog id="my_modal_3" class="modal">
    <div class="modal-box">
      <form id="update-form" method="dialog" class="space-y-3">
        <button
          type="button"
          class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          onclick="my_modal_3.close()"
        >
          âœ•
        </button>
        <h3 class="text-lg font-bold">Update Product</h3>

        <!-- Hidden input to store Product ID -->
        <input type="hidden" id="update-id" />

        <div>
          <label class="label">Product Name</label>
          <input
            type="text"
            id="update-name"
            class="input input-bordered w-full"
          />
        </div>

        <div>
          <label class="label">Category</label>
          <input
            type="text"
            id="update-category"
            class="input input-bordered w-full"
            readonly
            disabled
          />
        </div>

        <div>
          <label class="label">Barcode</label>
          <input
            type="text"
            id="update-barcode"
            class="input input-bordered w-full"
            readonly
            disabled
          />
        </div>

        <div>
          <label class="label">Price</label>
          <input
            type="number"
            id="update-price"
            class="input input-bordered w-full"
          />
        </div>

        <div class="modal-action">
          <button type="submit" class="btn btn-primary w-full">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    $(document).ready(async function () {
      const table = $("#product-table").DataTable({
        responsive: true,
        pageLength: 5,
        lengthMenu: [5, 10, 20, 50],
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Search products...",
        },
        dom: '<"flex justify-between items-center mb-4"<"flex space-x-2"l><"search-input"f>>rtip', // Custom DOM for Tailwind layout
        // Disable default classes to prevent style conflict
        renderer: "bootstrap",
      });

      try {
        const response = await fetch(
          "https://glp-basecode-api-sarisaristore.onrender.com/api/product/getAllProduct"
        );
        if (!response.ok)
          throw new Error(`Failed to fetch products: ${response.status}`);

        const result = await response.json();
        const products = result.data;

        table.clear();

        products.forEach((item) => {
          table.row.add([
            `<span class="font-medium">${item.productName}</span>`,
            item.categoryName,
            item.barcode,
            item.price,
            `<button 
                class="btn btn-sm btn-primary update-btn" 
                data-id="${item.productId}" 
                data-name="${item.productName}" 
                data-category="${item.categoryName}" 
                data-barcode="${item.barcode}" 
                data-price="${item.price}"
              >
                Edit
              </button>`,
          ]);
        });

        table.draw();
      } catch (error) {
        console.error("Error loading products:", error);
      }

      $("#product-table tbody").on("click", ".update-btn", function () {
        const btn = $(this);

        // Populate modal inputs
        $("#update-id").val(btn.data("id"));
        console.log(btn.data("id"));
        $("#update-name").val(btn.data("name"));
        $("#update-category").val(btn.data("category"));
        $("#update-barcode").val(btn.data("barcode"));
        $("#update-price").val(btn.data("price"));

        // Show the modal
        my_modal_3.showModal();
      });

      $("#update-form").on("submit", async function (e) {
        e.preventDefault();

        const id = parseInt($("#update-id").val(), 10);
        const data = {
          productName: $("#update-name").val(),
          categoryName: $("#update-category").val(),
          barcode: $("#update-barcode").val(),
          price: parseFloat($("#update-price").val()),
        };

        console.log("Saving updated product:", data);

        try {
          const response = await fetch(
            `https://glp-basecode-api-sarisaristore.onrender.com/api/product/updateProduct/${id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            alert("Update failed: " + error.message);
            return;
          }

          alert("Product updated successfully!");

          // Optionally reload the DataTable data here (e.g., call your fetch and redraw)
          // Or just close modal and update row in-place if you prefer

          // Close modal
          my_modal_3.close();
        } catch (err) {
          alert("Unexpected error: " + err.message);
        }

        // Optionally, refresh the DataTable
      });
    });
  </script>
</html>
